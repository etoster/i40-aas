dist: bionic
language: minimal
git:
  depth: 1

if: (branch = improve-travis OR branch = master ) AND (type = push OR type = pull_request)

env:
  global:
    - REGISTRY=$AZURE_CONTAINER_REGISTRY
    - BUILD_TAG=$(cat .git/refs/heads/${TRAVIS_BRANCH})

before_install:
  - make --version
  - docker --version
  - docker-compose --version

stages:
  - lib-test
  - unit-test
  - integration-test
  - test # use as build stage
  - name: deploy
    if: type = push

jobs:
  include:
    - stage: integration-test
      language: node_js
      node_js: lts/*
      install:
        - yarn global add newman
        - make
        - docker-compose -f docker-compose.yml up -d --force-recreate
        - sleep 60
      script:
        - newman run docs/postman/AAS.postman_collection.json --delay-request 2000 --folder "Check that mock adapter is empty" --folder "Send Interaction Message to https-endpoint" --folder "Check that mock adapter is populated"
        - newman run docs/postman/AAS.postman_collection.json \
            --delay-request 2000 \
            --folder "Check that mock adapter is empty" \
            --folder "Send Interaction Message to https-endpoint" \
            --folder "Check that mock adapter is populated"

