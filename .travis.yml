dist: bionic
language: minimal
git:
  depth: 1

if: (branch = ci-rework OR branch = master) AND (type = push OR type = pull_request)

env:
  global:
    - BUILD_TAG=$(cat .git/refs/heads/${TRAVIS_BRANCH})

stages:
  - lib-test
  - test
  - integration-test
  - name: publish
    if: type = push

jobs: 
  include:
## Tests run but are broken
#    - stage: lib-test
#      language: node_js
#      node_js: lts/*
#      install: 
#        - docker-compose up -d rabbitmq
#        - cd src/ts/pkg/AMQP-Client
#        - npm i 
#      script:
#        - npm test 
#        - docker-compose stop rabbitmq

## WORKS
#    - stage: lib-test
#      language: go 
#      env: GO111MODULE="on"
#      install: 
#        - docker-compose up -d rabbitmq
#        - cd src/go/pkg/amqpclient
#        - go mod download
#      script:
#        - go test 
#        - docker-compose stop rabbitmq 

#    - stage: unit-test
#      env: 
#      install: 
#        - make test-single

    - stage: integration-test
      language: node_js
      node_js: lts/*
      install: 
        - npm install -g newman
#        - make 
#        - docker-compose -f docker-compose.yml up -d --force-recreate
        - yes | docker-compose -f docker-compose.yml up -d 
#        - nc -z localhost 5672
#        - echo $?
        - while ! nc -z localhost 5672; do
            sleep 1;
          done
        - newman run docs/postman/AAS.postman_collection.json

#    - stage: publish
#      install:
#        - make push-single

# an welcher Stage push single?
      


before_install:
  - make --version
  - docker --version
  - docker-compose --version


